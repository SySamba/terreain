<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réservations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Réserver une Heure</h1>
        <form id="reservation-form" class="mt-4">
            <div class="mb-3">
                <label for="nom" class="form-label">Nom</label>
                <input type="text" class="form-control" id="nom" placeholder="Entrez votre nom" required>
            </div>
            <div class="mb-3">
                <label for="telephone" class="form-label">Téléphone</label>
                <input type="text" class="form-control" id="telephone" placeholder="Entrez votre numéro" required>
            </div>
            <div class="mb-3">
                <label for="type_reservation" class="form-label">Type de Réservation</label>
                <input type="text" class="form-control" id="type_reservation" placeholder="Type de réservation" required>
            </div>
            <div class="mb-3">
                <label for="moyen_paiement" class="form-label">Moyen de Paiement</label>
                <input type="text" class="form-control" id="moyen_paiement" placeholder="Moyen de paiement" required>
            </div>
            <div class="mb-3">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Heure</label>
                <div id="heures-disponibles" class="d-flex flex-wrap gap-2"></div>
            </div>
            <div id="error-message" style="display: none; color: red; text-align: center; margin-top: 10px;"></div>
            <button type="submit" class="btn btn-primary">Réserver</button>
        </form>
    </div>

    <script>
        const allHours = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"];
        const heuresContainer = document.getElementById('heures-disponibles');
        let selectedHour = null;

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').setAttribute('min', today);

        document.getElementById('date').addEventListener('change', async (event) => {
            const date = event.target.value;
            heuresContainer.innerHTML = '<p>Chargement des heures...</p>';

            try {
                const response = await axios.get(`/api/heures-disponibles?date=${date}`);
                const heures = response.data;

                heuresContainer.innerHTML = '';
                allHours.forEach(hour => {
                    const button = document.createElement('button');
                    button.className = `btn ${heures.includes(hour) ? 'btn-secondary' : 'btn-outline-primary'}`;
                    button.textContent = hour;
                    button.disabled = heures.includes(hour);
                    button.addEventListener('click', () => {
                        selectedHour = hour;
                        document.querySelectorAll('#heures-disponibles button').forEach(btn => btn.classList.remove('btn-primary'));
                        button.classList.add('btn-primary');
                    });
                    heuresContainer.appendChild(button);
                });
            } catch (error) {
                showError('Erreur lors du chargement des heures.');
            }
        });

        document.getElementById('reservation-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const nom = document.getElementById('nom').value;
            const telephone = document.getElementById('telephone').value;
            const type_reservation = document.getElementById('type_reservation').value;
            const moyen_paiement = document.getElementById('moyen_paiement').value;
            const date = document.getElementById('date').value;

            if (!nom || !telephone || !type_reservation || !moyen_paiement || !date || !selectedHour) {
                showError('Veuillez remplir tous les champs et sélectionner une heure.');
                return;
            }

            try {
                const response = await axios.post('/reserver', { nom, telephone, type_reservation, moyen_paiement, date, heure: selectedHour });
                alert(response.data.message);
                document.getElementById('reservation-form').reset();
                heuresContainer.innerHTML = '';
                selectedHour = null;
            } catch (error) {
                showError(error.response.data.error || 'Erreur lors de la réservation.');
            }
        });

        function showError(message) {
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
